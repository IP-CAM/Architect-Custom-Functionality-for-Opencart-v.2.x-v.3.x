<?xml version="1.0" encoding="utf-8"?>
<architect>
    <name>Logs Viewer</name>
    <version>1.0.1</version>
    <author>iSenseLabs</author>
    <link>https://github.com/iSenseLabs/architect/tree/gist</link>

    <note>Extend Error Log to show all log files.</note>
    <description><![CDATA[Extend Error Log to show all log files, view screenshot.<br>Simplified version of the Free <a href="https://isenselabs.com/products/view/errorlog-manager-multiple-error-log-files-manager">ErrorLog Manager</a>]]></description>
    <opencart>3.0.3.2, 3.0.3.1, 3.0.3.0, 3.0.2.0, 3.0.1.3, 3.0.1.2, 3.0.1.1, 2.3.0.2, 2.3.0.1, 2.3.0.0, 2.2.0.0, 2.1.0.2, 2.1.0.1, 2.0.3.1, 2.0.2.0</opencart>

    <modification><![CDATA[
<?xml version="1.0" encoding="utf-8"?>
<modification>
    <name>{ocmod_name}</name>
    <version>1.0.0</version>
    <author>iSenseLabs</author>
    <link>https://github.com/iSenseLabs/architect/tree/gist</link>
    <code>{ocmod_code}</code>

    <file path="admin/controller/tool/log.php">
        <operation info="Method index">
            <search><![CDATA[$data['log'] = '';]]]]><![CDATA[></search>
            <add position="after"><![CDATA[
            // Architect - Logs Viewer
            $data['viewLogFile']  = $this->url->link('tool/log', 'user_token=' . $this->session->data['user_token'], true);
            $data['logFiles'] = array();

            $logFiles = glob(DIR_LOGS . '*.{log,txt}', GLOB_BRACE);
            foreach ($logFiles as $file) {
                $filename = basename($file);
                $data['logFiles'][$filename] = array(
                    'name' => $filename,
                    'size' => $this->filesize($file),
                    'view' => $data['viewLogFile'] . '&file=' . $filename
                );
            }

            $log_file = !empty($this->request->get['file']) ? $this->request->get['file'] : $this->config->get('config_error_filename');
            $data['currentLogFile'] = '';
            if (!empty($data['logFiles'][$log_file])) {
                $data['currentLogFile'] = $data['logFiles'][$log_file]['name'] . ' | ' . $data['logFiles'][$log_file]['size'];
                $data['download'] = $data['download'] . '&file=' . $data['logFiles'][$log_file]['name'];
                $data['clear'] = $data['clear'] . '&file=' . $data['logFiles'][$log_file]['name'];
            }
            // Architect - Logs Viewer :: end
            ]]]]><![CDATA[></add>
        </operation>
        <operation info="Method index">
            <search><![CDATA[$data['log'] = file_get_contents($file, FILE_USE_INCLUDE_PATH, null);]]]]><![CDATA[></search>
            <add position="replace"><![CDATA[
            // Architect - Logs Viewer
            # $data['log'] = file_get_contents($file, FILE_USE_INCLUDE_PATH, null);
            $data['log'] = htmlentities(file_get_contents($file, FILE_USE_INCLUDE_PATH, null));
            // Architect - Logs Viewer :: end
            ]]]]><![CDATA[></add>
        </operation>
        <operation info="Method index, download, and clear">
            <search><![CDATA[$file = DIR_LOGS . $this->config->get('config_error_filename');]]]]><![CDATA[></search>
            <add position="replace"><![CDATA[
            // Architect - Logs Viewer
            # $file = DIR_LOGS . $this->config->get('config_error_filename');
            $log_file = !empty($this->request->get['file']) ? $this->request->get['file'] : $this->config->get('config_error_filename');
            $file = DIR_LOGS . $log_file;
            // Architect - Logs Viewer :: end
            ]]]]><![CDATA[></add>
        </operation>
        
        <operation info="Method download">
            <search><![CDATA['_error.log"']]]]><![CDATA[></search>
            <add position="replace"><![CDATA['_' . $log_file . '"']]]]><![CDATA[></add>
        </operation>
        <operation info="Method download and clear">
            <search><![CDATA[$this->response->redirect($this->url->link('tool/log', 'user_token=' . $this->session->data['user_token'], true));]]]]><![CDATA[></search>
            <add position="replace"><![CDATA[
            // Architect - Logs Viewer
            if (!empty($log_file)) {
                $this->response->redirect($this->url->link('tool/log', 'user_token=' . $this->session->data['user_token'] . '&file=' . basename($file), true));
            } else {
                $this->response->redirect($this->url->link('tool/log', 'user_token=' . $this->session->data['user_token'], true));
            }
            // Architect - Logs Viewer :: end
            ]]]]><![CDATA[></add>
        </operation>
        <operation>
            <search><![CDATA[public function download() {]]]]><![CDATA[></search>
            <add position="before"><![CDATA[
            /**
             * Architect - Logs Viewer
             * Calculate filesize
             */
            protected function filesize($file) {
                $size = filesize($file);
                $suffix = array('B', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB');

                $i = 0;
                while (($size / 1024) > 1) {
                    $size = $size / 1024;
                    $i++;
                }

                return round(substr($size, 0, strpos($size, '.') + 4), 2) . $suffix[$i];
            }
            ]]]]><![CDATA[></add>
        </operation>
    </file>
    <file path="admin/view/template/tool/log.twig">
        <operation>
            <search><![CDATA[<h3 class="panel-title">]]]]><![CDATA[></search>
            <add position="after"><![CDATA[
            <!-- Architect - Logs Viewer -->
            <div class="btn-group architect-log-select">
              <button class="btn btn-default btn-sm dropdown-toggle" data-toggle="dropdown">{{ currentLogFile ?: 'Select' }} <i class="fa fa-caret-down"></i></button>
              <ul class="dropdown-menu dropdown-menu-right">
                {% for file in logFiles %}
                  <li><a href="{{ file.view }}">{{ file.name ~ ' | ' ~ file.size }}</a></li>
                {% endfor %}
              </ul>
            </div>
            <style>
            .architect-log-select {
              float: right;
              margin-top: -5px;
              margin-right: -8px;
            }
            .architect-log-select .btn-sm {
              padding-left: 12px;
              padding-right: 10px;
            }
            .architect-log-select .fa-caret-down {
              margin-left: 8px;
            }
            </style>
            <!-- Architect - Logs Viewer :: end -->
            ]]]]><![CDATA[></add>
        </operation>
        <operation>
            <search><![CDATA[rows="15"]]]]><![CDATA[></search>
            <add position="replace"><![CDATA[rows="25"]]]]><![CDATA[></add>
        </operation>
    </file>
</modification>
]]></modification>
</architect>
